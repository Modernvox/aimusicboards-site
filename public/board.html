<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Board ‚Ä¢ AI Music Boards</title>

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#000000">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #07070c;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.95);
      --muted: rgba(255,255,255,0.68);

      --gold: #d4af37;
      --green: #2ecc71;
      --blue: #4aa3ff;
      --red: #ff3b30;

      --cta: #f08a2a;
      --cta2: #ff9c45;

      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --max: 1180px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }
    a{ color: inherit; text-decoration:none; }
    .muted{ color: var(--muted); }

    .wrap{
      width: min(var(--max), calc(100% - 48px));
      margin: 0 auto;
    }

    /* ---------- Top Nav (matches homepage) ---------- */
    header{
      position: sticky;
      top: 0;
      z-index: 60;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(7,7,12,.78), rgba(7,7,12,.28));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .nav{
      height: 74px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 18px;
    }
    .brand{
      font-weight: 900;
      letter-spacing: .6px;
      text-transform: uppercase;
      font-size: 20px;
      white-space: nowrap;
    }
    .navlinks{
      display:flex;
      align-items:center;
      gap: 22px;
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      color: rgba(255,255,255,.82);
    }
    .navlinks a{ opacity:.9; }
    .navlinks a:hover{ opacity:1; }
    .navright{
      display:flex;
      align-items:center;
      gap: 12px;
      white-space: nowrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 800;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .4px;
      cursor: pointer;
      user-select: none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(109,92,255,.95), rgba(74,163,255,.85));
      border-color: rgba(255,255,255,.14);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      font-weight: 900;
      letter-spacing: .4px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      white-space: nowrap;
    }

    /* ---------- Board background shell (same vibe) ---------- */
    .page{
      position: relative;
      padding: 34px 0 70px;
      isolation: isolate;
    }
    .page::before{
        content:"";
        position:absolute;
        inset: 0;
        z-index: -2;
        background:
            url("https://imagedelivery.net/fYqzQPf1CS3qAF1vZpfSLw/9801e636-13ed-4627-946e-ccbfc2e54e00/public")
                center / cover no-repeat,
            radial-gradient(1200px 700px at 50% 18%, rgba(109,92,255,.22), rgba(0,0,0,0) 60%),
            radial-gradient(1100px 650px at 70% 42%, rgba(74,163,255,.18), rgba(0,0,0,0) 58%),
            radial-gradient(900px 520px at 30% 60%, rgba(212,175,55,.10), rgba(0,0,0,0) 62%),
            linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,0) 55%);

        /* üîÜ Brightness controls */
        filter: brightness(1.15) contrast(1.05) saturate(1.05);
        opacity: .9;
    }


    .page::after{
        content:"";
        position:absolute;
        inset:0;
        z-index:-1;
        background:
            radial-gradient(900px 540px at 50% 18%, rgba(0,0,0,.05), rgba(0,0,0,.25) 65%),
            linear-gradient(to bottom, rgba(0,0,0,.10), rgba(7,7,12,.92));
        pointer-events:none;
    }


    .title-row{
      max-width: 980px;
      margin: 0 auto 16px auto;
      text-align: center;
    }
    .kicker{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .7px;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
      margin-bottom: 10px;
    }
    .h1{
      margin: 0 0 10px 0;
      font-size: clamp(28px, 4.2vw, 46px);
      font-weight: 900;
      letter-spacing: -.6px;
      text-transform: uppercase;
      text-shadow: 0 10px 36px rgba(0,0,0,.55);
    }
    .sub{
      margin: 0 auto;
      max-width: 780px;
      color: rgba(255,255,255,.75);
      line-height: 1.45;
      font-size: 15px;
    }

    /* ---------- Board Card ---------- */
    .board{
      max-width: 980px;
      margin: 18px auto 0 auto;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      position: relative;
    }
    .board::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(900px 260px at 50% 0%, rgba(109,92,255,.18), rgba(0,0,0,0) 60%),
        radial-gradient(850px 240px at 50% 42%, rgba(212,175,55,.12), rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    .board-inner{ position: relative; padding: 18px; }

    .board-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .board-top-left{
      display:flex;
      align-items:baseline;
      gap: 10px;
      flex-wrap: wrap;
    }
    .board-top h2{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .8px;
      text-transform: uppercase;
    }
/* Fan vote UI */
.fanVoteBox{
  margin-top: 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.28);
  padding: 12px;
}

.fanRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.fanMeta{
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .4px;
  font-size: 12px;
  color: rgba(255,255,255,.80);
}

.fanMeta b{ color: var(--gold); }

.fanControls{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}

.fanSlider{
  width: 220px;
  accent-color: var(--gold);
}

.fanValue{
  min-width: 32px;
  text-align:center;
  font-weight: 900;
  color: rgba(255,255,255,.92);
}

.fanBtn{
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .4px;
  font-size: 12px;
  cursor: pointer;
}
.fanBtn:hover{ background: rgba(255,255,255,.09); }
.fanBtn:disabled{ opacity:.55; cursor:not-allowed; }

.fanInline{
  margin-top: 6px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .35px;
  font-size: 12px;
  color: rgba(255,255,255,.72);
}
.fanInline b{ color: var(--gold, #d4af37); }

.live-btn .live-dot{
  width:8px;height:8px;border-radius:999px;display:inline-block;
  background: rgba(255,255,255,.35);
  margin-right:8px;
}
.live-btn.is-live .live-dot{ background: rgba(46,204,113,.95); }
.live-btn.is-offline .live-dot{ background: rgba(255,255,255,.35); }

    .qualify{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      font-weight: 800;
      letter-spacing: .25px;
      white-space: nowrap;
    }
    .qualify b{ color: var(--gold); }

    .board-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .refresh{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }

    /* ---------- Desktop Table ---------- */
    .tablewrap{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      overflow:hidden;
    }
    table{ width:100%; border-collapse: collapse; font-size: 13px; }
    thead th{
      text-align:left;
      padding: 12px 14px;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.78);
      text-transform: uppercase;
      letter-spacing: .6px;
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }
    tbody td{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom: none; }

    .col-rank{ width: 64px; }
    .col-total{ width: 110px; }
    .col-listen{ width: 110px; }

    tbody tr.rank-1{ background: rgba(212,175,55,.10); }
    tbody tr.rank-2{ background: rgba(74,163,255,.06); }
    tbody tr.rank-3{ background: rgba(46,204,113,.06); }

    .listen{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .35px;
      font-size: 12px;
      white-space: nowrap;
    }
    .listen:hover{ background: rgba(255,255,255,.09); }

    /* ---------- Mobile Cards ---------- */
    .mobile{ display:none; }
    .cards{ display:flex; flex-direction: column; gap: 10px; }
    .item{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.30);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
    }
    .rankBox{
      flex:0 0 auto;
      width:44px; height:44px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      letter-spacing: .4px;
      color: rgba(255,255,255,.85);
    }
    .item.top1 .rankBox{
      background: rgba(212,175,55,.16);
      border-color: rgba(212,175,55,.35);
      color: rgba(255,255,255,.92);
    }
    .meta2{ flex:1 1 auto; min-width: 0; }
    .artist{
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .2px;
      font-size: 13px;
      color: rgba(255,255,255,.92);
      line-height: 1.2;
    }
    .track{
      margin-top: 4px;
      font-size: 13px;
      color: rgba(255,255,255,.80);
      line-height: 1.25;
      word-break: break-word;
    }
    .row2{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      margin-top: 10px;
    }
    .scorePill{
      font-weight: 900;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }
    .scorePill b{ color: var(--gold); }

    .empty{
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: rgba(255,255,255,.72);
      text-align: center;
    }
/* ‚úÖ NEW: sort toggle row in board header */
.sortRow{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.22);
  backdrop-filter: blur(8px);
}

/* make the sort buttons compact + pill-like */
.sortRow .sortBtn{
  padding: 8px 12px;
  font-size: 12px;
  border-radius: 999px;
  border: 1px solid transparent;
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.86);
  font-weight: 900;
  letter-spacing: .4px;
}

/* active state */
.sortRow .sortBtn.active{
  background: linear-gradient(180deg, rgba(212,175,55,.92), rgba(212,175,55,.70));
  color: #1a1406;
  border-color: rgba(0,0,0,.22);
}

/* hover state */
.sortRow .sortBtn:hover{
  background: rgba(255,255,255,.10);
}
.sortRow .sortBtn.active:hover{
  filter: brightness(1.02);
}

    /* ---------- Responsive ---------- */
    @media (max-width: 980px){
      .navlinks{ display:none; }
    }
    @media (max-width: 720px){
      .wrap{ width: calc(100% - 28px); }
      .nav{ height: 68px; }
      .brand{ font-size: 18px; }

      .tablewrap{ display:none; }
      .mobile{ display:block; }
      .board-inner{ padding: 14px; }
        /* ---------- NAV: compact on mobile ---------- */
        header .nav{
            height: 62px;
            gap: 10px;
        }

        header .brand{
            font-size: 16px;
            letter-spacing: .55px;
        }

        header .navright{
            gap: 8px;
        }

        header .navright .btn{
            padding: 8px 12px;
            font-size: 11px;
            border-radius: 11px;
        }
.board-actions{
    width: 100%;
    justify-content: center;
    gap: 8px;
  }

  .sortRow{
    order: 2;
  }

  .sortRow .sortBtn{
    padding: 7px 10px;
    font-size: 11px;
  }
    }
  </style>
</head>

<body>
 <!-- NAV -->
  <header>
    <div class="wrap">
      <div class="nav">
        <div class="brand">AI MUSIC BOARDS</div>

        <nav class="navlinks" aria-label="primary">
          <a href="https://aimusicboards.com/">Home</a>
          <a href="https://aimusicboards.com/board">Leaderboard</a>
          <a href="https://aimusicboards.com/submit">Submit Music</a>
        </nav>

        <div class="navright">
<a id="watchBtn"
   class="btn primary live-btn is-offline"
   href="https://www.tiktok.com/@snapink.official"
   target="_blank"
   rel="noopener">
  <span class="live-dot"></span>
  <span class="live-label">VIEW CHANNEL</span>
</a>      
  </div>
      </div>
    </div>
  </header>

  <!-- PAGE -->
  <main class="page">
    <div class="wrap">
      <div class="title-row">
        <div class="kicker">Leaderboard</div>
        <h1 class="h1">AI MUSIC BOARD</h1>
        <p class="sub">Only tracks scoring <b style="color:var(--gold);font-weight:900;">40+</b> make the board. Updated live during broadcasts.</p>
      </div>

      <section class="board" aria-label="Leaderboard board">
        <div class="board-inner">
          <div class="board-top">
            <div class="board-top-left">
              <h2>Leaderboard</h2>
              <div class="qualify">Qualifying: <b>40+</b> total</div>
            </div>

            <div class="board-actions">
              <div class="pill" id="lastUpdated">Updated: ‚Äî</div>

              <!-- ‚úÖ NEW: Sort toggle (Judge vs Fan) -->
              <div class="sortRow" role="group" aria-label="Sort leaderboard">
                <button class="btn sortBtn active" id="sortJudge" type="button" data-sort="judge">Judge</button>
                <button class="btn sortBtn" id="sortFan" type="button" data-sort="fan">Fan</button>
              </div>

              <button class="btn refresh" id="refreshBtn" type="button">Refresh</button>
            </div>
          </div>

          <!-- Desktop table -->
          <div class="tablewrap desktop" aria-label="Leaderboard table">
            <table>
              <thead>
                <tr>
                  <th class="col-rank">Rank</th>
                  <th>Artist</th>
                  <th>Track</th>
                  <th class="col-total">Total</th>
                  <th class="col-listen">Listen</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile cards -->
          <div class="mobile" aria-label="Mobile leaderboard">
            <div class="cards" id="cards">
              <div class="empty muted">Loading‚Ä¶</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Fan Vote Modal -->
  <div id="voteModal" style="display:none; position:fixed; inset:0; z-index:9999;">
    <div id="voteModalBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.55);"></div>

    <div style="position:relative; margin:12vh auto 0 auto; width:min(520px, calc(100% - 28px));
                border:1px solid rgba(255,255,255,.14); border-radius:16px;
                background:rgba(0,0,0,.78); backdrop-filter:blur(12px);
                box-shadow:0 18px 50px rgba(0,0,0,.55); padding:16px 16px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:900; text-transform:uppercase; letter-spacing:.6px; color:rgba(255,255,255,.92);">
          Thank you
        </div>

        <button id="voteModalClose" type="button"
          style="border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06);
                 color:rgba(255,255,255,.9); border-radius:10px; padding:8px 10px; font-weight:900; cursor:pointer;">
          ‚úï
        </button>
      </div>

      <div style="margin-top:10px; color:rgba(255,255,255,.78); line-height:1.35;">
        Your vote has been added.
      </div>

      <div style="margin-top:14px; display:flex; justify-content:flex-end;">
        <button id="voteModalOk" type="button"
          style="border:0; background:linear-gradient(180deg, rgba(212,175,55,.92), rgba(212,175,55,.72));
                 color:#1a1406; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer;">
          OK
        </button>
      </div>
    </div>
  </div>

<script>
  // ---------------- Header live button (Watch Live vs View Channel) ----------------
  const TIKTOK_URL = "https://www.tiktok.com/@snapink.official";

  function setLiveButton(isLive){
    const btn = document.getElementById("watchBtn");
    if (!btn) return;

    btn.href = TIKTOK_URL;

    const label = btn.querySelector(".live-label");
    if (label) label.textContent = isLive ? "WATCH LIVE" : "VIEW CHANNEL";

    btn.classList.toggle("is-live", !!isLive);
    btn.classList.toggle("is-offline", !isLive);
    btn.classList.toggle("live", !!isLive); // supports .btn.primary.live ring styling
  }

  async function pollStatus(){
    try{
      const r = await fetch("/api/status", { cache: "no-store" });
      const s = await r.json();
      setLiveButton(!!s.submissions_open);
    } catch {
      setLiveButton(false);
    }
  }

  // ---------------- Existing leaderboard script ----------------
  const lastUpdatedEl = document.getElementById("lastUpdated");
  const refreshBtn = document.getElementById("refreshBtn");

  // ‚úÖ YOUR REAL SORT BUTTON IDS (from your HTML)
  const sortJudgeBtn = document.getElementById("sortJudge");
  const sortFanBtn   = document.getElementById("sortFan");

  let sortMode = "judge"; // "judge" | "fan"

  function fmtTime(d){
    return d.toLocaleString(undefined, {
      month: "short",
      day: "2-digit",
      hour: "numeric",
      minute: "2-digit"
    });
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#039;"
    }[m]));
  }

  function safeNumber(n, fallback="‚Äî"){
    const x = Number(n);
    return Number.isFinite(x) ? String(x) : fallback;
  }

  function safeNum(n, fallback=0){
    const x = Number(n);
    return Number.isFinite(x) ? x : fallback;
  }

  // ‚úÖ IMPORTANT: Convert DB track_url to a real playable URL
  // This is the logic that made your MP3s work:
  // - /uploads/...  -> /r2/uploads/...   (public handler)
  // - /r2/...       -> pass through
  // - absolute URLs -> pass through
  // - uploads/...   -> normalize to /r2/uploads/...
  function makePlayableUrl(raw){
    const url = String(raw ?? "").trim();
    if (!url) return "";

    // If DB stores /uploads/..., route through R2 handler
    if (url.startsWith("/uploads/")) return "/r2" + url;

    // Already correct
    if (url.startsWith("/r2/")) return url;

    // Handle "uploads/..." without leading slash
    if (url.startsWith("uploads/")) return "/r2/" + url;

    // Normalize full URLs pointing to /uploads/
    try{
      const parsed = new URL(url, location.origin);
      if (parsed.origin === location.origin && parsed.pathname.startsWith("/uploads/")){
        return "/r2" + parsed.pathname;
      }
    } catch {}

    // External links (SoundCloud, YouTube, etc.)
    return url;
  }

  // ---------------- Fan voting helpers ----------------
  function openVoteModal(){
    const m = document.getElementById("voteModal");
    if (m) m.style.display = "block";
  }
  function closeVoteModal(){
    const m = document.getElementById("voteModal");
    if (m) m.style.display = "none";
  }

  function renderFanInline(el, avg, count){
    if (!el) return;
    const a = Number(avg || 0);
    const c = Number(count || 0);

    if (c <= 0) {
      el.innerHTML = `Fan Rating: <b>‚Äî</b> (0 votes)`;
      return;
    }

    el.innerHTML = `Fan Rating: <b>‚≠ê ${a.toFixed(2)}</b> (${c} ${c === 1 ? "vote" : "votes"})`;
  }

  function updateInlineFanLabels(submissionId, avg, count){
    if (!submissionId) return;
    document
      .querySelectorAll(`[data-fan-inline="1"][data-submission-id="${CSS.escape(submissionId)}"]`)
      .forEach(el => renderFanInline(el, avg, count));
  }

  (function bindVoteModal(){
    const closeBtn = document.getElementById("voteModalClose");
    const okBtn = document.getElementById("voteModalOk");
    const backdrop = document.getElementById("voteModalBackdrop");
    closeBtn?.addEventListener("click", closeVoteModal);
    okBtn?.addEventListener("click", closeVoteModal);
    backdrop?.addEventListener("click", closeVoteModal);
  })();

  async function fetchVoteStats(submissionId){
    const r = await fetch(`/api/vote_stats?submission_id=${encodeURIComponent(submissionId)}`, { cache:"no-store" });
    return await r.json();
  }

  async function postVote(submissionId, rating){
    const r = await fetch("/api/vote", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ submission_id: submissionId, rating })
    });
    const j = await r.json().catch(() => ({}));
    return { ok: r.ok && j.ok, status: r.status, body: j };
  }

  async function buildFanVoteBox(submissionId){
    const box = document.createElement("div");
    box.className = "fanVoteBox";
    box.innerHTML = `
      <div class="fanRow">
        <div class="fanMeta">
          Fan: <b class="fanAvg">‚Äî</b> (<span class="fanCount">‚Äî</span>)
        </div>

        <div class="fanControls">
          <input class="fanSlider" type="range" min="1" max="10" step="1" value="8" aria-label="Fan vote slider" />
          <div class="fanValue">8</div>
          <button class="fanBtn" type="button">Vote</button>
        </div>
      </div>
      <div class="fanMeta fanHint" style="margin-top:8px; color:rgba(255,255,255,.70);"></div>
    `;

    const avgEl = box.querySelector(".fanAvg");
    const countEl = box.querySelector(".fanCount");
    const hintEl = box.querySelector(".fanHint");
    const slider = box.querySelector(".fanSlider");
    const valueEl = box.querySelector(".fanValue");
    const btn = box.querySelector(".fanBtn");

    function setMeta(avg, count){
      const a = Number(avg || 0);
      const c = Number(count || 0);

      if (avgEl) avgEl.textContent = (Number.isFinite(a) && a > 0) ? a.toFixed(2) : "‚Äî";
      if (countEl) countEl.textContent = String(Number.isFinite(c) ? c : "‚Äî");

      updateInlineFanLabels(submissionId, a, c);
    }

    slider?.addEventListener("input", () => {
      if (valueEl) valueEl.textContent = String(slider.value);
    });

    // load stats
    try{
      const st = await fetchVoteStats(submissionId);
      const a = Number(st.avg_rating || 0);
      const c = Number(st.vote_count || 0);
      setMeta(a, c);

      if (st.your_vote != null){
        if (hintEl) hintEl.textContent = `You already voted: ${st.your_vote}/10`;
        if (btn) btn.disabled = true;
        if (slider) slider.disabled = true;
        if (valueEl) valueEl.textContent = String(st.your_vote);
        if (slider) slider.value = String(st.your_vote);
      } else {
        if (hintEl) hintEl.textContent = "Vote once (1 = horrible, 10 = phenomenal).";
      }
    } catch {
      if (hintEl) hintEl.textContent = "Voting temporarily unavailable.";
      if (btn) btn.disabled = true;
      if (slider) slider.disabled = true;
    }

    btn?.addEventListener("click", async () => {
      if (!slider || !btn) return;

      const rating = Number(slider.value);
      btn.disabled = true;

      try{
        const res = await postVote(submissionId, rating);

        if (!res.ok){
          const err = res.body?.error || "vote_failed";
          if (hintEl) {
            if (err === "already_voted" || err === "already_voted_ip") hintEl.textContent = "You already voted for this song.";
            else if (err === "not_eligible") hintEl.textContent = "Voting is only for leaderboard songs.";
            else hintEl.textContent = "Could not submit vote. Please try again.";
          }
          btn.disabled = false;
          return;
        }

        const avg = Number(res.body.avg_rating || 0);
        const count = Number(res.body.vote_count || 0);
        setMeta(avg, count);

        if (hintEl) hintEl.textContent = `Vote recorded: ${rating}/10`;
        if (slider) slider.disabled = true;

        // if sorting by fan, refresh ranks after vote
        if (sortMode === "fan") {
          try { await load(); } catch {}
        }

        openVoteModal();
      } catch {
        if (hintEl) hintEl.textContent = "Could not submit vote. Please try again.";
        btn.disabled = false;
      }
    });

    return box;
  }

  // ---------------- Sorting ----------------
  function setSortMode(mode){
    sortMode = (mode === "fan") ? "fan" : "judge";
    sortJudgeBtn?.classList.toggle("active", sortMode === "judge");
    sortFanBtn?.classList.toggle("active", sortMode === "fan");
  }

  sortJudgeBtn?.addEventListener("click", () => { setSortMode("judge"); load(); });
  sortFanBtn?.addEventListener("click", () => { setSortMode("fan"); load(); });

  // ---------------- Main load ----------------
  async function load(){
    if (lastUpdatedEl) lastUpdatedEl.textContent = "Updated: ‚Ä¶";

    let j;
    try{
      const r = await fetch("/api/board", { cache: "no-store" });
      j = await r.json();
      if (lastUpdatedEl) lastUpdatedEl.textContent = "Updated: " + fmtTime(new Date());
    }catch(e){
      if (lastUpdatedEl) lastUpdatedEl.textContent = "Updated: ‚Äî";
      const rows = document.getElementById("rows");
      const cards = document.getElementById("cards");
      if (rows) rows.innerHTML = `<tr><td colspan="5" class="muted">Unable to load right now. Please refresh.</td></tr>`;
      if (cards) cards.innerHTML = `<div class="empty">Unable to load right now. Please refresh.</div>`;
      return;
    }

    const rows = document.getElementById("rows");
    const cards = document.getElementById("cards");
    if (rows) rows.innerHTML = "";
    if (cards) cards.innerHTML = "";

    let items = Array.isArray(j?.items) ? j.items : [];

    if (items.length === 0){
      if (rows) rows.innerHTML = `<tr><td colspan="5" class="muted">No approved tracks yet.</td></tr>`;
      if (cards) cards.innerHTML = `<div class="empty">No approved tracks yet.</div>`;
      return;
    }

    // sort by fan if the API provides fan_avg/fan_votes
    if (sortMode === "fan"){
      items = items.slice().sort((a, b) => {
        const aAvg = safeNum(a.fan_avg, 0);
        const bAvg = safeNum(b.fan_avg, 0);
        const aVotes = safeNum(a.fan_votes, 0);
        const bVotes = safeNum(b.fan_votes, 0);

        if (bAvg !== aAvg) return bAvg - aAvg;
        if (bVotes !== aVotes) return bVotes - aVotes;

        const aTotal = safeNum(a.total ?? a.judge_total, 0);
        const bTotal = safeNum(b.total ?? b.judge_total, 0);
        if (bTotal !== aTotal) return bTotal - aTotal;

        return 0;
      });
    }

    for (let idx = 0; idx < items.length; idx++){
      const it = items[idx];
      const rank = idx + 1;

      const submissionId = String(it.submission_id || "").trim();
      const artist = escapeHtml(it.artist_name);
      const track = escapeHtml(it.track_title);

      // judge total display
      const total = safeNumber(it.total ?? it.judge_total);

      // ‚úÖ make track_url actually playable
      const rawUrl = String(it.track_url ?? "");
      const playUrl = makePlayableUrl(rawUrl);

      // fan inline values if present
      const fanAvgInline = safeNum(it.fan_avg, 0);
      const fanVotesInline = safeNum(it.fan_votes, 0);

      // Desktop main row
      const tr = document.createElement("tr");
      tr.className = rank === 1 ? "rank-1" : (rank === 2 ? "rank-2" : (rank === 3 ? "rank-3" : ""));
      tr.innerHTML = `
        <td><strong>#${rank}</strong></td>
        <td>${artist || "‚Äî"}</td>
        <td>
          ${track || "‚Äî"}
          <div class="fanInline" data-fan-inline="1" data-submission-id="${escapeHtml(submissionId)}">
            Fan Rating: <b>‚Äî</b> (0 votes)
          </div>
        </td>
        <td><strong>${total}</strong></td>
        <td>${playUrl ? `<a class="listen" href="${escapeHtml(playUrl)}" target="_blank" rel="noopener">Play</a>` : `<span class="muted">‚Äî</span>`}</td>
      `;
      rows?.appendChild(tr);

      // Set inline immediately if we have values
      if (submissionId){
        updateInlineFanLabels(submissionId, fanAvgInline, fanVotesInline);
      }

      // Desktop vote row (full-width)
      const tr2 = document.createElement("tr");
      tr2.innerHTML = `<td class="fanTd" colspan="5"></td>`;
      rows?.appendChild(tr2);

      if (submissionId){
        const voteBox = await buildFanVoteBox(submissionId);
        tr2.querySelector("td")?.appendChild(voteBox);
      } else {
        tr2.querySelector("td").innerHTML = `<div class="muted">Voting unavailable (missing submission_id).</div>`;
      }

      // Mobile card (‚úÖ fixed: no <td> inside div)
      const div = document.createElement("div");
      div.className = "item" + (rank === 1 ? " top1" : "");
      div.innerHTML = `
        <div class="rankBox">#${rank}</div>
        <div class="meta2">
          <div class="artist">${artist || "‚Äî"}</div>
          <div class="track">${track || "‚Äî"}</div>

          <div class="fanInline" data-fan-inline="1" data-submission-id="${escapeHtml(submissionId)}">
            Fan Rating: <b>‚Äî</b> (0 votes)
          </div>

          <div class="row2">
            <div class="scorePill">Total: <b>${total}</b></div>
            <div>
              ${playUrl ? `<a class="listen" href="${escapeHtml(playUrl)}" target="_blank" rel="noopener">Play</a>` : `<span class="muted">‚Äî</span>`}
            </div>
          </div>

          <div class="fanMount" style="margin-top:10px;"></div>
        </div>
      `;
      cards?.appendChild(div);

      // Inline on mobile too
      if (submissionId){
        updateInlineFanLabels(submissionId, fanAvgInline, fanVotesInline);
      }

      const mount = div.querySelector(".fanMount");
      if (mount && submissionId){
        const voteBox2 = await buildFanVoteBox(submissionId);
        mount.appendChild(voteBox2);
      }
    }
  }

  refreshBtn?.addEventListener("click", load);

  // default state
  setSortMode("judge");

  // Kick everything off
  pollStatus();
  setInterval(pollStatus, 6000);

  load();
  setInterval(load, 30000);
</script>


</body>
</html>
